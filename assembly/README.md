

# XIAOGYANの組立手順

IoT ALGYANの8周年基板の組立手順を示します．


# はじめに
ハードウェア構成のイメージを持った後に，**部品の確認**と**機材の確認**を行いましょう！

## ハードウェアの構成の理解
<img src="img/block_diagram.png" width="800">

XIAOGYANの構成は，マイコン(XIAO ESP32C3)を中心に，入力としてロータリーエンコーダー，ボタン×2と，出力としてLEDマトリックス，スピーカーを有します．
また，ロータリーエンコーダーには，LEDが内蔵されています．この内蔵LEDの制御信号(D6)は分岐しており，基板上のLED(U13・未実装)にも接続されています．

加えて，I2Cの信号線が繋がるGroveコネクタも用意されており，任意のGroveモジュール(3.3V駆動品)を拡張する事も可能です．
I2Cの制御信号は，基板左のユニバーサル基板の区画にも伸びています．このユニバーサル基板に回路を拡張すればすべてオンボードとすることも可能です．

## 部品の確認
<img src="img/parts_list.png" width="800">

- [パーツリスト](./parts_list.pdf)

上記のパーツリストをダウンロード後に印刷し，部品を並べることで部品の不足がないことを確認しましょう．

1. チップ抵抗やチップコンデンサは，袋から取り出すと，容量の確認が非常に困難です．袋から取り出す際には必ず容量(XXXΩ，YYYuFなど)を紙テープに書き込みましょう．
2. 部品の確認表に**赤字で「向き注意」**と書かれている部品は，**取り付けに向きがあります．**はんだ付けの際には注意しましょう．
3. それでは部品の確認表に部品を並べましょう！

## 機材の確認
<img src="img/img01.PNG" width="800">

上記に組立に必要な機材のリストを示します．機材は手元に揃っていますか？
**※**マークのついた部品は，オプションです．手元に無くとも組立は可能です．


## 組立＆動作確認の流れ
以降でXIAOGYANの組立＆動作確認を行います．組立は手慣れた人で2時間程度かと思われます．
流れは以下の通りです．

1. 組立作業
    1. 表面実装品のはんだ付け
    2. 挿入実装品のはんだ付け
    3. 足の取り付け
    4. アンテナの固定
2. 動作確認
    1. ショートチェック
    2. 開発環境の構築
    3. 動作確認プログラムの書き込み
    4. 動作の確認

# 組立作業
## はんだ付けの経験が浅い方へ
https://www.youtube.com/watch?v=dQ7AUjb1tkA

イチケンさんのはんだ付け動画が分かりやすいです．
一度，ご覧の上以降の作業に進んで下さい．

## 基板の確認
<img src="img/img11.PNG" width="800">
<img src="img/img12.PNG" width="800">
基板の表裏を確認します．部品はすべて表面に乗ることになります．

## 基板裏面のショートジャンパ
<img src="img/img21.PNG" width="800">
基板の裏面には2か所ほどはんだ付けでショートさせる箇所があります．
まずは，この2か所のはんだ付けから行います．

<img src="img/img22.PNG" width="400">
まずはJP1のショートから行います．
これは，LEDマトリックスを制御するドライバIC(TM1640)の動作電圧を選択する為のものです．
今回は3.3Vで動作させますので，3V3側にショートさせます．黄色の部分をはんだでショートさせて下さい．

<img src="img/img23.PNG" width="400">
続いてJP3のショートを行います．
これは，マイコンのD3ピンをスピーカーの有効/無効を制御するSPeaker ENable信号として使用するか，CN2(AN1)に自己拡張した回路で使用するかを選択する為のものです．
今回はスピーカーの有効/無効を制御する用途で使用しますので，SPEN側にショートさせます．黄色の部分をはんだでショートさせて下さい．

## 表面実装品のはんだ付け
表面実装部品でも挿入実装部品でも**背の低い部品**からはんだ付けしていく事が鉄則です．以下の流れに沿って進めましょう．

0. 初めて表面実装のはんだ付けを行う方へ
初めて表面実装のはんだ付けを行う方は，以下のリンク先から表面実装部品のはんだ付け方法について確認ください．わかりやすく解説されています．

- [古賀電子 > 表面実装部品(SMD)のはんだ付け](https://www.kogadenshi.co.jp/%E5%8D%8A%E7%94%B0%E4%BB%98%E3%81%91%E3%83%86%E3%82%AF%E3%83%8B%E3%83%83%E3%82%AF/%E8%A1%A8%E9%9D%A2%E5%AE%9F%E8%A3%85%E9%83%A8%E5%93%81-smd-%E3%81%AE%E5%8D%8A%E7%94%B0%E4%BB%98%E3%81%91/)


1. チップ抵抗(0Ω)のはんだ付け

<img src="img/img31.PNG" width="800">

リスト①のチップ抵抗(0Ω)のはんだ付けを行います．黄枠で囲った箇所[R7,R8,R9]にはんだ付けを行って下さい．
尚，特に極性は特にありませんが，同じ向きに揃えて実装できると綺麗ですね :-)

2. チップ抵抗(10KΩ)のはんだ付け

<img src="img/img32.PNG" width="800">

リスト②のチップ抵抗(10KΩ)のはんだ付けを行います．黄枠で囲った箇所[R1,R2,R3,R4,R5,R6]にはんだ付けを行って下さい．
尚，特に極性は特にありませんが，同じ向きに揃えて実装できると綺麗ですね :-)


3. チップコンデンサ(0.1uF)のはんだ付け

<img src="img/img41.PNG" width="800">

続いてチップコンデンサを実装します．0.1uF, 1uF, 10uFの3種類のチップコンデンサを使用します．
まずはリスト③の**0.1uFのコンデンサ**を実装します．青枠で囲った箇所にはんだ付けして下さい．


4. チップコンデンサ(1uF)のはんだ付け

<img src="img/img42.PNG" width="800">

リスト④の**1uFのコンデンサ**を実装します．青枠で囲った箇所にはんだ付けして下さい．


5. チップコンデンサ(10uF)のはんだ付け

<img src="img/img43.PNG" width="800">

リスト⑤の**10uFのコンデンサ**を実装します．青枠で囲った箇所にはんだ付けして下さい．

6. チップ抵抗＆チップコンデンサの実装確認

<img src="img/img44.PNG" width="800">

実装漏れはありませんか？あとで漏れに気づいてはんだ付けするには大変です．上図のマークアップ部分にチップ抵抗orチップコンデンサが実装されているか確認をしましょう！

7. LEDドライバIC(TM1640)のはんだ付け

<img src="img/img51.PNG" width="800">

最後の表面実装です．リスト⑥のLEDドライバICを実装します．黄枠で囲った箇所にはんだ付けして下さい．
尚，**本部品には取り付け向きがあります．**注意してください．

// 図を入れる

基板のU2の●にICの●が重なる事を確認した後に，はんだ付けをして下さい．

以上で表面実装部品のはんだ付けは完了です．
ひとやすみした後に挿入実装品のはんだ付けへ進んで下さい．


## 挿入実装品のはんだ付け
挿入実装部品でも**背の低い部品**からはんだ付けしていく事が鉄則です．以下の流れに沿って進めましょう．

1. アンプIC(NJM2113D)のはんだ付け

<img src="img/img61.PNG" width="800">

リスト⑦のアンプICを実装します．黄枠で囲った箇所にはんだ付けして下さい．
尚，**本部品には取り付け向きがあります．**注意してください．

// 図を入れる

ICには取り付け向きがあります．切り欠きの向きが一致するように取り付けてください．

尚，新品のICは足がやや広がっており，そのままではソケットに挿しづらいです．
両足をやや内側に曲げた後に挿してください．

// 図を入れる

はんだ付け時に固定が難しい場合はマスキングテープを使いましょう！


2. ボタン・可変抵抗のはんだ付け

<img src="img/img62.PNG" width="800">

リスト⑧のボタン・可変抵抗を実装します．黄枠で囲った箇所にはんだ付けして下さい．

可変抵抗は2種類の型番の部品が取り付くようになっています．
部品表の通りに部品を購入されている方は，▲に並んだスルーホールに刺さる可変抵抗が手元にあるはずです．

3. スピーカー・LEDマトリックスのはんだ付け

<img src="img/img71.PNG" width="800">

リスト⑨のスピーカーとリスト⑩のLEDマトリックスを実装します．黄枠で囲った箇所にはんだ付けして下さい．
尚，**2つの部品には取り付け向きがあります．**注意してください．

// 図を入れる

スピーカーの場合，部品裏面にある+と-が，基板の+と-に一致するように取り付けてください．
また，はんだ付け時に固定が難しい場合はマスキングテープを使いましょう！

// 図を入れる

LEDマトリックスの場合，側面に印字された「型番ラベル」と基板に印字された「=== label side ===」が，一致するように取り付けてください．
また，はんだ付け時に固定が難しい場合はマスキングテープを使いましょう！


4. Groveコネクタのはんだ付け

<img src="img/img73.PNG" width="800">

リスト⑪のGroveコネクタを実装します．黄枠で囲った箇所にはんだ付けして下さい．
尚，**本部品には取り付け向きがあります．**注意してください．

// 図を入れる

コネクタの突起が基板のシルクと一致するような向きで取り付けてください．
また，はんだ付け時に固定が難しい場合はマスキングテープを使いましょう！


5. マイコンの取り付け

// 図を入れる

リスト⑬のマイコンに対して，リスト⑫の細ピンヘッダを実装します．
細ピンヘッダを実装する事により，マイコンをXIAOGYANから取り外すことが可能となり他のXIAOシリーズのマイコンに置き換えることも可能となります．

<img src="img/img74.PNG" width="800">

リスト⑫の分割ロングピンソケットをを実装します．黄枠で囲った箇所にはんだ付けして下さい．
はんだ付け時に固定が難しい場合はマスキングテープを使いましょう！

はんだ付けの終了後は，ピンソケットにマイコンを刺して下さい．


6. ロータリーエンコーダーのはんだ付け

<img src="img/img72.PNG" width="800">

リスト⑭のスピーカーとリスト⑩のLEDマトリックスを実装します．黄枠で囲った箇所にはんだ付けして下さい．
ロータリーエンコーダーは2種類のエンコーダーが取り付くようになっています．
推奨品の場合は赤枠に，オプション品の場合は黄枠に取り付けます．

推奨品(赤枠)の場合は，他の部品と同様に上記のように取り付けます．

オプション品(青枠)の場合は，基板の裏面から取付穴に部品を固定した後にはんだ付けを行います．
エンコーダの足と基板のスルーホールまでは距離がありますが，足を反対側に折り曲げると綺麗に届きます．



## 足の取り付け

<img src="img/img52.PNG" width="800">

基板の4ヶ所にはφ3.5mmの穴があいています．
基板の裏面が不用意にショートして故障とならないよう足を取り付けましょう．

## アンテナの固定

<img src="img/img81.PNG" width="800">

ケーブルタイを使用することで，マイコン(Seeeduino XIAO ESP32C3)のアンテナを固定する事ができます．
お好みで固定してください．

## 基板の左部分のユニバーサル基板について
XIAOGYANにセンサ等を拡張したい時に使用できるユーザランドです．
自由に活用ください．

以上で組立作業は完了です．お疲れ様でした．
続いては基板の動作確認を行っていきます．

# 動作確認
## ショートチェック
基板に火を入れる(通電する)前に，致命的なミスが無いか最低限のチェックを行います．

これより電源ラインのショートチェックを行います．
XIAOGYANには5Vおよび3.3Vの2つの電源系統が存在します．電源とGND間の抵抗値が低い場合，基板のどこかに短絡の可能性があり，このまま通電すると高い確率で壊れます．

そこで，テスターを抵抗レンジに設定し，測定ポイントのA～Cの抵抗値をそれぞれ計測します．


## 開発環境の構築
推奨環境はVSCode+PlatformIOです．
構築方法は別ページをご覧ください．

## 動作確認プログラムの書き込み
HardwareTestを手元にcloneして書き込んでみて下さい！

## 動作の確認
チェックリストを埋めたらOK！完成！やったね！
